#!/bin/sh
# Git hook: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∫–æ–º–º–∏—Ç–æ–º

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É version.json
VERSION_FILE="public/version.json"
PACKAGE_FILE="package.json"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–µ —Å—á–∏—Ç–∞—è —Å–∞–º–æ–≥–æ version.json)
if git diff --cached --name-only | grep -qv "^public/version.json$\|^package.json$"; then
  echo "üì¶ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏..."
  
  # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –∏–∑ version.json
  CURRENT_VERSION=$(node -p "require('./public/version.json').version")
  CURRENT_BUILD=$(node -p "require('./public/version.json').build")
  
  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º patch –≤–µ—Ä—Å–∏—é
  IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
  NEW_PATCH=$((PATCH + 1))
  NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
  NEW_BUILD=$((CURRENT_BUILD + 1))
  
  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
  CURRENT_DATE=$(date +%Y-%m-%d)
  
  # –û–±–Ω–æ–≤–ª—è–µ–º version.json
  cat > "$VERSION_FILE" <<EOF
{
  "version": "$NEW_VERSION",
  "build": "$NEW_BUILD",
  "date": "$CURRENT_DATE",
  "description": "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏"
}
EOF
  
  # –û–±–Ω–æ–≤–ª—è–µ–º package.json
  node -e "
    const fs = require('fs');
    const pkg = JSON.parse(fs.readFileSync('$PACKAGE_FILE', 'utf8'));
    pkg.version = '$NEW_VERSION';
    fs.writeFileSync('$PACKAGE_FILE', JSON.stringify(pkg, null, 2) + '\n');
  "
  
  # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ–º–º–∏—Ç
  git add "$VERSION_FILE" "$PACKAGE_FILE"
  
  echo "‚úÖ –í–µ—Ä—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞: $CURRENT_VERSION ‚Üí $NEW_VERSION (build $NEW_BUILD)"
else
  echo "‚ÑπÔ∏è  –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ version.json/package.json, –≤–µ—Ä—Å–∏—è –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è"
fi

exit 0

