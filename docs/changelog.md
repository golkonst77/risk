# Changelog - BA Copilot

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и проект следует [Semantic Versioning](https://semver.org/lang/ru/).

## [1.3.20] - 2026-01-02 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.20
- Обновлен package.json

## [1.3.19] - 2026-01-02 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.19
- Обновлен package.json

## [1.3.18] - 2026-01-02 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.18
- Обновлен package.json

## [1.3.17] - 2026-01-02 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.17
- Обновлен package.json

## [1.3.16] - 2026-01-02 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.16
- Обновлен package.json

## [1.3.15] - 2026-01-02 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.15
- Обновлен package.json

## [1.3.14] - 2026-01-01 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.14
- Обновлен package.json

## [1.3.13] - 2026-01-01 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.13
- Обновлен package.json

## [1.3.12] - 2025-12-22 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.3.12
- Обновлен package.json

## [1.2.0] - 2025-10-11 - Запуск и тестирование парсера АУСН

### Добавлено
- ✅ Успешный запуск и тестирование модуля парсера АУСН
- Парсинг 69 активных регионов с фильтрацией по кодам (01-99)
- Парсинг 11 уполномоченных банков для АУСН
- Автоматическое определение таблиц по заголовкам
- Валидация данных (фильтрация заголовков, проверка формата)
- Логирование процесса парсинга с указанием найденных таблиц

### Исправлено
- Корректная фильтрация регионов (было 85, стало 69)
- Разделение парсинга таблиц регионов и банков
- Исключение неактивных регионов и строк заголовков
- Проверка формата кода региона (регулярное выражение)
- Проверка формата ИНН банка (только цифры)

### Структура данных
**Регионы** (`public/data/regions.json`):
```json
{
  "version": "2025-10-11",
  "lastUpdate": "2025-10-11T12:26:18.195Z",
  "source": "nalog.gov.ru",
  "count": 69,
  "data": [{"code": "01", "name": "Республика Адыгея"}, ...]
}
```

**Банки** (`public/data/banks.json`):
```json
{
  "version": "2025-10-11",
  "lastUpdate": "2025-10-11T12:14:16.077Z",
  "source": "nalog.gov.ru",
  "count": 11,
  "data": [
    {
      "inn": "7707083893",
      "ogrn": "1027700132195",
      "name": "ПАО Сбербанк",
      "dateAdded": "27.06.2022"
    },
    ...
  ]
}
```

### Список банков
1. АО КБ «Модульбанк» (23.06.2022)
2. ПАО Сбербанк (27.06.2022)
3. АО «Альфа-Банк» (27.06.2022)
4. ПАО «Промсвязьбанк» (28.06.2022)
5. АО «ТБанк» (26.07.2022)
6. ПАО Банк ВТБ (10.08.2022)
7. ПАО АКБ «АК БАРС» (03.11.2022)
8. ООО «БЛАНК БАНК» (09.01.2023)
9. ООО «Банк Точка» (13.03.2023)
10. АО «Россельхозбанк» (24.04.2023)
11. ПАО «СДМ-Банк» (12.08.2024)

### Документация
- Обновлена документация `docs/ausn-parser-integration.md`
- Добавлены детали парсинга и список банков
- Описаны алгоритмы фильтрации данных

### Команды
- `npm run parse:once` - однократный парсинг (в ausn-parser/)
- `npm run update-data` - копирование данных в проект (в AUSN_V1/)

## [1.1.0] - 2025-10-11 - Модуль парсера данных АУСН и обновления UI

### Добавлено
- Создан автономный модуль `ausn-parser` для парсинга данных с сайта ФНС
- Автоматическое обновление справочников регионов и банков АУСН
- Планировщик задач (cron) для еженедельного обновления данных
- Система логирования с записью в файлы
- Обработка ошибок с повторными попытками
- Скрипт копирования данных в основной проект (`npm run update-data`)
- Документация интеграции парсера (`docs/ausn-parser-integration.md`)

### Структура модуля парсера
- `ausn-parser/src/index.js` - главный файл с координацией
- `ausn-parser/src/config.js` - конфигурация URL и селекторов
- `ausn-parser/src/parsers/regions-parser.js` - парсер регионов
- `ausn-parser/src/parsers/banks-parser.js` - парсер банков
- `ausn-parser/src/utils/logger.js` - система логирования
- `ausn-parser/src/utils/file-manager.js` - работа с файлами
- `ausn-parser/src/utils/scheduler.js` - планировщик задач
- `ausn-parser/output/` - выходные JSON файлы

### Особенности
- Модуль полностью автономен с собственными зависимостями
- Запуск в режиме демона с автообновлением по расписанию
- Однократный запуск для тестирования (`npm run parse:once`)
- Валидация данных и сравнение с предыдущими версиями
- Сохранение метаинформации (версия, дата обновления, источник)
- Fallback на старые данные при ошибках парсинга

### Интеграция
- JSON файлы доступны по `/data/regions.json` и `/data/banks.json`
- Автоматическое копирование через `npm run update-data`
- Кэширование с query параметрами `?v=${timestamp}`
- Fallback на дефолтные данные при недоступности

### Технические детали
- Node.js 18+
- Dependencies: axios, cheerio, node-cron, dotenv
- Настройка через `.env` файл
- Поддержка retry механизма
- Цветные логи в консоли

### Калькулятор АУСН
- Создан новый модульный калькулятор сравнения налоговых режимов
- Поддержка расчёта для всех систем налогообложения:
  - УСН "Доходы" 6%
  - УСН "Доходы минус расходы" 15%
  - ОСНО (для ИП и ООО)
  - АУСН "Доходы" 8%
  - АУСН "Доходы минус расходы" 20%
- Полный учёт страховых взносов:
  - Фиксированные взносы ИП (49,500 + 1% свыше 300,000)
  - Взносы за сотрудников (30.2% от ФОТ)
  - Взносы на травматизм для АУСН (0.2%)
- Уменьшение налога УСН 6% на взносы
- Минимальные налоги для УСН 15% (1%) и АУСН 20% (3%)
- Автоматическая рекомендация лучшего режима
- Расчёт экономии в рублях и процентах
- Проверка соответствия лимитам АУСН (≤60 млн, ≤5 сотрудников)
- Визуальное выделение оптимального варианта
- Детальная таблица сравнения всех режимов
- Список уполномоченных банков для АУСН
- Модульная архитектура для лёгкого обновления

**Компоненты калькулятора:**
- Calculator.tsx, CalculatorForm.tsx, CalculatorResults.tsx
- ComparisonTable.tsx (раскрывающаяся), EligibilityChecker.tsx
- calculator-config.ts - конфигурация и функции расчёта
- types.ts - TypeScript интерфейсы
- Документация: docs/calculator-ausn.md (722 строки)

### UI/UX улучшения
- Обновлено главное меню сайта (новые названия разделов)
- Убран badge версии из header
- Упрощены пункты меню (чистый дизайн без серых кнопок)
- Телефон в header теперь иконка с tooltip
- Header растянут на всю ширину экрана
- Обновлен title сайта: "Просто Бюро - Портал АУСН"
- Улучшена страница "Инструкции по АУСН" (8 карточек + FAQ)
- Ввод данных в калькуляторе в тысячах рублей для удобства

## [1.0.14] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.14
- Обновлен package.json

## [1.0.13] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.13
- Обновлен package.json

## [1.0.12] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.12
- Обновлен package.json

## [1.0.11] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.11
- Обновлен package.json

## [1.0.10] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.10
- Обновлен package.json

## [1.0.9] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.9
- Обновлен package.json

## [1.0.8] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.8
- Обновлен package.json

## [1.0.7] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.7
- Обновлен package.json

## [1.0.6] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.6
- Обновлен package.json

## [1.0.5] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.5
- Обновлен package.json

## [1.0.4] - 2025-10-08 - Автоматическое обновление версии

### Изменено
- Автоматическое обновление версии до 1.0.4
- Обновлен package.json

## [2025-08-30] - Система управления видимостью секций по устройствам и Email уведомления

### Добавлено
- **Система управления видимостью секций по устройствам**:
  - Новая страница админки `/admin/visibility` для управления видимостью
  - Отдельные настройки для мобильных (≤1024px) и десктопных (≥1024px) устройств
  - Хук `useDeviceType` для определения типа устройства
  - Обновленная структура данных в `homepage-sections.json`
  - API endpoint `/api/admin/visibility` для сохранения настроек
  - Статистика по включенным/отключенным секциям для каждого типа устройств
  - Интеграция с главной страницей для условного рендеринга секций
  - Добавлена ссылка "Видимость секций" в быстрые действия админки

- **Система Email уведомлений для администратора**:
  - API endpoint `/api/admin/notify-quiz-completion` для отправки уведомлений
  - Автоматические уведомления при завершении квиза клиентом
  - Использование встроенного email сервиса Supabase
  - Детальная информация о клиенте: телефон, скидка, тип бизнеса, ответы на вопросы
  - Fallback на консольное логирование при ошибках отправки

### Изменено
- **Структура данных**: `homepage-sections.json` теперь содержит отдельные настройки `desktop` и `mobile` для каждой секции
- **Хук useHomepageSections**: Обновлен для поддержки параметра `deviceType` в функции `isSectionVisible`
- **Главная страница**: Интегрирована с системой определения типа устройства и условного рендеринга
- **Админка**: Добавлена карточка "Видимость секций" в быстрые действия
- **Квиз**: Добавлена отправка email уведомлений администратору при завершении

### Технические детали
- **Определение устройства**: mobile (≤1024px), desktop (≥1024px)
- **API**: POST `/api/admin/visibility` для сохранения настроек
- **Интерфейс**: Современный дизайн с переключателями и статистикой
- **Производительность**: Мгновенное применение изменений без перезагрузки
- **Email уведомления**: Встроенный Supabase email сервис с fallback на консоль
- **Данные уведомления**: Телефон, скидка, тип бизнеса, купон, все ответы на вопросы

## [Unreleased]

### Добавлено
- Настройка GitHub репозитория для отслеживания изменений
- README.md с полным описанием проекта
- Улучшенный .gitignore для Python и Node.js
- MIT лицензия для проекта
- Пример переменных окружения (env.example)

### Исправлено
- Удален дублированный код в компоненте ImportYandexReviewsJSON
- Исправлена ошибка сборки Next.js с повторными импортами
- Устранены конфликты имен функций и компонентов
- **Унификация квизов**: Удален второй квиз (quiz-modal-tariff.tsx) и заменен на основной квиз во всех местах
- **Очистка кода**: Удален неиспользуемый компонент CruiseQuizModal

### Изменено
- Улучшена обработка ошибок в Python парсере
- Оптимизирована загрузка отзывов
- **Все кнопки квизов теперь открывают единый квиз**: pricing-section, /pricing/ip, /pricing/ooo

## [1.0.0] - 2025-08-30

### Добавлено
- **Система отзывов**: Полная реализация парсинга и отображения отзывов с Яндекс.Карт
  - Python парсер для извлечения отзывов (`scripts/yandex_parser.py`)
  - API для удаленного парсинга по companyId (`/api/generate-yandex-json-remote`)
  - Локальная система отображения отзывов (`/api/local-reviews`)
  - Компонент отзывов с пагинацией (`components/reviews.tsx`)
  - Административная панель для управления отзывами

- **Парсинг отзывов**:
  - Поддержка 39 отзывов с полной информацией
  - Обработка русских дат (например, "4 марта" → ISO формат)
  - Случайное перемешивание отзывов
  - Клиентская пагинация по 3 отзыва на страницу

- **Административная панель**:
  - Интерфейс для генерации JSON из Яндекс.Карт
  - Выбор companyId для парсинга
  - Импорт отзывов из JSON файлов
  - Управление настройками сайта

- **API Endpoints**:
  - `GET /api/local-reviews` - Получение локальных отзывов
  - `POST /api/generate-yandex-json-remote` - Генерация JSON из Яндекс.Карт
  - `POST /api/import-yandex-reviews-json` - Импорт отзывов в Supabase
  - `GET /api/settings` - Получение настроек сайта
  - `POST /api/settings` - Обновление настроек
  - `GET /api/test-supabase-simple` - Тест подключения к Supabase
  - `GET /api/debug-env` - Отладка переменных окружения

### Изменено
- **Архитектура парсинга**: Переход от прямого импорта в базу данных к двухэтапному процессу (Яндекс.Карты → JSON → Frontend)
- **Обработка кодировки**: Использование stdin/stdout для передачи данных между Node.js и Python
- **Fallback система**: Локальный JSON файл как резервный источник данных при проблемах с Supabase

### Исправлено
- **Парсер отзывов**: Удалено ограничение `[:5]` в Python скрипте, теперь извлекаются все 39 отзывов
- **Парсинг дат**: Добавлена функция `parseRussianDate()` для корректной обработки русских дат
- **Обработка ошибок**: Улучшена обработка ошибок при парсинге и загрузке данных

### Технические детали
- **Python зависимости**: beautifulsoup4, lxml, requests
- **Кодировка**: Принудительная установка UTF-8 для Python скриптов
- **Производительность**: Время загрузки отзывов ~50ms
- **Размер данных**: JSON файл с 39 отзывами ~15KB

## [0.9.0] - 2025-08-30

### Добавлено
- **Базовая структура проекта**:
  - Next.js 14 с App Router
  - TypeScript конфигурация
  - Material UI и Tailwind CSS
  - Supabase интеграция

- **Компоненты**:
  - Базовая структура компонентов
  - Административная панель
  - Настройки сайта

### Изменено
- Инициализация проекта
- Настройка окружения разработки

### Исправлено
- Базовые настройки проекта

## [0.8.0] - 2025-08-30

### Добавлено
- **Инициализация проекта**:
  - Создание репозитория
  - Настройка базовой структуры
  - Конфигурация зависимостей

### Технические детали
- **Node.js**: 18+
- **Next.js**: 14.0.0
- **React**: 18.2.0
- **TypeScript**: 5.0.0

---

## Типы изменений

- **Добавлено** - для новых функций
- **Изменено** - для изменений в существующих функциях
- **Устарело** - для функций, которые скоро будут удалены
- **Удалено** - для удаленных функций
- **Исправлено** - для исправления ошибок
- **Безопасность** - для исправлений уязвимостей

## Соглашения

### Версионирование

Проект следует [Semantic Versioning](https://semver.org/lang/ru/):

- **MAJOR** версия для несовместимых изменений API
- **MINOR** версия для добавления функциональности с обратной совместимостью
- **PATCH** версия для исправлений ошибок с обратной совместимостью

### Формат записей

Каждая запись должна содержать:
- **Дату** в формате YYYY-MM-DD
- **Тип изменения** (Добавлено/Изменено/Исправлено и т.д.)
- **Краткое описание** изменений
- **Технические детали** при необходимости

### Примеры записей

```markdown
### Добавлено
- Новая функция парсинга отзывов
- API endpoint для получения данных

### Изменено
- Улучшена производительность загрузки
- Обновлен дизайн компонента

### Исправлено
- Ошибка с кодировкой файлов
- Проблема с отображением дат
```

---

*Документ ведется с момента создания проекта*
*Последнее обновление: 2025-08-30* 

## [2025-08-30] - Восстановление системы управления секциями и исправление навигации

### Исправлено
- **Восстановлена система управления видимостью секций** - вернул правильную работу `useHomepageSections` с API
- **Исправлено верхнее меню** - добавлены `id` атрибуты для всех секций (services, pricing, faq, calculator)
- **Упрощен Header компонент** - убрана сложная логика загрузки настроек
- **Добавлена проверка загрузки** на главной странице с индикатором загрузки
- **Выделен заголовок FAQ синим фоном** - "Приборная Панель: Ответы на главные вопросы" теперь с синим фоном

### Технические изменения
- Восстановлен `hooks/use-homepage-sections.ts` с правильной работой API
- Обновлен `app/page.tsx` с проверкой загрузки конфигурации
- Добавлены `id` атрибуты в компоненты: `services.tsx`, `pricing-section.tsx`, `faq.tsx`, `calculator.tsx`
- Упрощен `components/header.tsx` для стабильной работы

### Статус
✅ Сайт работает стабильно без ошибок F5
✅ Верхнее меню полностью функционально
✅ Система управления видимостью секций через админку работает
✅ Все секции корректно отображаются/скрываются

## [2025-08-30] - Настройка WhatsApp API и исправление квиза

### Добавлено
- **Интеграция с WhatsApp API** (whapi.cloud) для отправки сообщений
- **Обработка ошибок** в функциях отправки WhatsApp
- **Тестовый скрипт** для проверки WhatsApp API
- **Документация WhatsApp сервиса** с тарифом и статусом

### Изменено
- **Текст в квизе** - добавлено "ЗВОНИТЬ НЕ БУДЕМ, ТОЛЬКО СООБЩЕНИЕ!"
- **Размер кнопок** в квизе увеличен для лучшей читаемости
- **Фон квиза** - добавлен светло-бежевый фон и фоновое изображение
- **Размер шрифтов** в квизе увеличен на 30%

### Исправлено
- **Прозрачность dropdown'ов** - заменено `bg-transparent` на `bg-white z-50`
- **Фон калькулятора** - добавлен фон при прокрутке на главной странице
- **Цвета элементов** в Hero секции - выделена кнопка тенью, изменен цвет бейджа

### WhatsApp Сервис
- **Провайдер**: whapi.cloud
- **Токен**: K9edm63ZcOVma3QQQZy4vQM7JQOSI1RF
- **Статус**: Активирован и оплачен
- **Тариф**: 600 ₽/мес (оплачен до 27.09.2025)
- **Функции**: ✅ Текстовые сообщения, ✅ Отправка файлов

### Проблемы
- Файлы (PDF чек-листы) не отправляются через WhatsApp API
- Требуется диагностика endpoint `/api/send-whatsapp-document` 